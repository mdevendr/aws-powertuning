name: Tune Lambda

on:
  repository_dispatch:
    types: [lambda-tune]

  workflow_dispatch:
    inputs:
      lambda_arn:
        description: "Lambda ARN to tune"
        required: false
        default: ""
      invoke_url:
        description: "API Invoke URL (for smoke tests)"
        required: false
        default: ""
      ask_approval:
        description: "Require manual approval before applying memory? (true/false)"
        required: false
        default: "true"
      strategy:
        description: "Tuning strategy (balanced | cost | speed)"
        required: false
        default: "balanced"
      power_values:
        description: "Comma-separated memory values"
        required: false
        default: "128,256,512,1024"

permissions:
  id-token: write
  contents: write
  issues: write

env:
  PROJECT: serverless-power-tuning
  DEFAULT_REGION: eu-west-2
  POWERTUNER_FALLBACK_ARN: arn:aws:states:us-west-2:211125489043:stateMachine:powerTuningStateMachine-8d6ae210-bb08-11f0-98f3-0656addddf6b
  DEPLOY_APPROVER: "mdevendr"

jobs:
  tune:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug OIDC Token (Show actual sub)
        run: |
          set -e
          # Request an ID token directly
          TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com" | jq -r '.value')

          curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com"
          echo "ðŸ”¹ Raw JWT:"
          echo "$TOKEN" | sed 's/\./\n/g' | sed -n '1p;2p;3p' > split.txt

          HEADER=$(sed -n '1p' split.txt | base64 --decode 2>/dev/null || true)
          PAYLOAD=$(sed -n '2p' split.txt | base64 --decode 2>/dev/null || true)

          echo ""
          echo "ðŸ”¹ Decoded Header:"
          echo "$HEADER" | jq .

          echo ""
          echo "ðŸ”¹ Decoded Payload:"
          echo "$PAYLOAD" | jq .

          echo ""
          echo "ðŸ‘‰ Copy the **sub** field from above and send it to me here."

      # âœ… MUST COME BEFORE ANY AWS CALLS
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.DEFAULT_REGION }}
          output-env-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node (for Newman)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Ensure CLI tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq zip

      - name: Resolve Inputs
        id: inputs
        run: |
          set -e

          LAMBDA_ARN="${{ github.event.client_payload.lambda_arn || github.event.inputs.lambda_arn }}"
          INVOKE_URL="${{ github.event.client_payload.invoke_url || github.event.inputs.invoke_url }}"
          ASK_APPROVAL="${{ github.event.inputs.ask_approval || 'true' }}"
          STRATEGY="${{ github.event.inputs.strategy || 'balanced' }}"
          POWER_VALUES="${{ github.event.inputs.power_values || '128,256,512,1024' }}"

          if [ -z "$LAMBDA_ARN" ]; then
            echo "âŒ LAMBDA_ARN missing"
            exit 1
          fi

          echo "lambda_arn=$LAMBDA_ARN" >> $GITHUB_OUTPUT
          echo "invoke_url=$INVOKE_URL" >> $GITHUB_OUTPUT
          echo "ask_approval=$ASK_APPROVAL" >> $GITHUB_OUTPUT
          echo "strategy=$STRATEGY" >> $GITHUB_OUTPUT
          echo "power_values=$POWER_VALUES" >> $GITHUB_OUTPUT

      - name: Determine Lambda Region
        id: lregion
        run: |
          REGION="$(echo '${{ steps.inputs.outputs.lambda_arn }}' | cut -d: -f4)"
          echo "region=${REGION:-${{ env.DEFAULT_REGION }}}" >> $GITHUB_OUTPUT

      - name: Locate Power Tuner State Machine
        id: tuner
        run: |
          REGION="${{ steps.lregion.outputs.region }}"
          find_tuner() {
            aws stepfunctions list-state-machines --region "$1" \
              --query "stateMachines[?contains(name, 'powerTuningStateMachine')].stateMachineArn" \
              --output text
          }

          TUNER="$(find_tuner "$REGION" || true)"
          if [ -n "$TUNER" ]; then
            echo "arn=$TUNER" >> $GITHUB_OUTPUT
            echo "region=$REGION" >> $GITHUB_OUTPUT
            exit 0
          fi

          TUNER="$(find_tuner us-west-2 || true)"
          if [ -n "$TUNER" ]; then
            echo "arn=$TUNER" >> $GITHUB_OUTPUT
            echo "region=us-west-2" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "arn=${{ env.POWERTUNER_FALLBACK_ARN }}" >> $GITHUB_OUTPUT
          echo "region=us-west-2" >> $GITHUB_OUTPUT

      - name: Run Power Tuner
        id: tune
        env:
          TUNER_ARN: ${{ steps.tuner.outputs.arn }}
          TUNER_REGION: ${{ steps.tuner.outputs.region }}
          LAMBDA_ARN: ${{ steps.inputs.outputs.lambda_arn }}
          STRATEGY: ${{ steps.inputs.outputs.strategy }}
          POWER_VALUES_CSV: ${{ steps.inputs.outputs.power_values }}
        run: |
          set -e
          PJSON="[$(echo $POWER_VALUES_CSV)]"
          INPUT=$(jq -n --arg lambda "$LAMBDA_ARN" --arg strat "$STRATEGY" --argjson pv "$PJSON" \
            '{lambdaARN:$lambda, powerValues:$pv, num:20, payload:{}, parallelInvocation:true, strategy:$strat}')

          EXE=$(aws stepfunctions start-execution \
            --region "$TUNER_REGION" \
            --state-machine-arn "$TUNER_ARN" \
            --input "$INPUT" \
            --query executionArn --output text)

          while true; do
            STATUS=$(aws stepfunctions describe-execution \
              --region "$TUNER_REGION" --execution-arn "$EXE" --query status --output text)
            [[ "$STATUS" == "SUCCEEDED" ]] && break
            [[ "$STATUS" =~ FAILED|ABORTED|TIMED_OUT ]] && exit 1
            sleep 8
          done

          aws stepfunctions describe-execution \
            --region "$TUNER_REGION" --execution-arn "$EXE" \
            --query output --output text > tuning-output.json

          BEST=$(jq -r '.power' tuning-output.json)
          echo "best=$BEST" >> $GITHUB_OUTPUT

      - name: Await Approval (if required)
        if: ${{ steps.inputs.outputs.ask_approval == 'true' }}
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ env.DEPLOY_APPROVER }}
          minimum-approvals: 1
          issue-title: "Approve Lambda memory update to ${{ steps.tune.outputs.best }} MB"
          issue-body: "Apply recommended memory to: ${{ steps.inputs.outputs.lambda_arn }}"

      - name: Apply Memory Update
        run: |
          FN=$(echo "${{ steps.inputs.outputs.lambda_arn }}" | awk -F: '{print $NF}')
          aws lambda update-function-configuration --function-name "$FN" --memory-size ${{ steps.tune.outputs.best }}

      - name: Run Smoke Tests (Newman)
        if: ${{ steps.inputs.outputs.invoke_url != '' }}
        run: |
          npm i -g newman newman-reporter-html
          mkdir -p reports
          newman run postman/collection.json \
            -e postman/env.json \
            --env-var apiBase="${{ steps.inputs.outputs.invoke_url }}" \
            --reporter-html-export reports/newman.html

      - name: Create Summary + Archive Reports
        run: |
          mkdir -p reports/history
          TS=$(date +%Y%m%d-%H%M%S)
          cp tuning-output.json reports/history/tuning-$TS.json
          cp reports/newman.html reports/history/newman-$TS.html || true
          echo "## Tuning Result: ${{ steps.tune.outputs.best }} MB" > reports/memory-change-summary.md

      - name: Commit reports
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add reports/history/* reports/memory-change-summary.md || true
          git commit -m "Add tuning reports" || true
          git push

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tuning-results
          path: reports/
