name: Lambda Power Tuning

on:
  repository_dispatch:
    types: [lambda-tune]

permissions:
  id-token: write
  contents: write
  issues: write

env:
  AWS_REGION: eu-west-2
  PROJECT: serverless-power-tuning
  ASK_APPROVAL: true # set false → automatic memory apply

jobs:
  tune:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 1️⃣ Receive Inputs from dispatch
      - name: Extract Payload
        id: payload
        run: |
          echo "LAMBDA_ARN=${{ github.event.client_payload.lambda_arn }}" >> $GITHUB_ENV
          echo "INVOKE_URL=${{ github.event.client_payload.invoke_url }}" >> $GITHUB_ENV
          echo "Using Lambda ARN: $LAMBDA_ARN"
          echo "Using API URL: $INVOKE_URL"

      # 2️⃣ Resolve Power Tuner State Machine
      - name: Locate Power Tuner State Machine
        id: tuner
        run: |
          EU=$(aws stepfunctions list-state-machines --region eu-west-2 \
            --query "stateMachines[?contains(name,'powerTuningStateMachine')].stateMachineArn" --output text)
          if [ -n "$EU" ]; then
            echo "POWER_TUNER_ARN=$EU" >> $GITHUB_ENV
            echo "POWER_TUNER_REGION=eu-west-2" >> $GITHUB_ENV
            exit 0
          fi

          US=$(aws stepfunctions list-state-machines --region us-west-2 \
            --query "stateMachines[?contains(name,'powerTuningStateMachine')].stateMachineArn" --output text)
          if [ -n "$US" ]; then
            echo "POWER_TUNER_ARN=$US" >> $GITHUB_ENV
            echo "POWER_TUNER_REGION=us-west-2" >> $GITHUB_ENV
            exit 0
          fi

          echo "❌ No tuner found"; exit 1

      # 3️⃣ Run AWS Lambda Power Tuner
      - name: Run Tuner
        id: tune
        run: |
          INPUT=$(jq -n \
            --arg lambda "$LAMBDA_ARN" \
            '{
              lambdaARN:$lambda,
              powerValues:[128,256,512,1024],
              num:20,
              payload:{},
              parallelInvocation:true,
              strategy:"balanced"
            }')

          EXE=$(aws stepfunctions start-execution \
            --region "$POWER_TUNER_REGION" \
            --state-machine-arn "$POWER_TUNER_ARN" \
            --input "$INPUT" --query executionArn --output text)

          while true; do
            STATUS=$(aws stepfunctions describe-execution \
              --region "$POWER_TUNER_REGION" \
              --execution-arn "$EXE" \
              --query status --output text)

            [ "$STATUS" = "SUCCEEDED" ] && break
            [[ "$STATUS" =~ FAILED|TIMED_OUT|ABORTED ]] && exit 1
            sleep 8
          done

          aws stepfunctions describe-execution \
            --region "$POWER_TUNER_REGION" \
            --execution-arn "$EXE" \
            --query output --output text > tuning-output.json

          BEST=$(jq -r '.power' tuning-output.json)
          echo "BEST=$BEST" >> $GITHUB_ENV
          echo "Recommended Memory: $BEST MB"

      # 4️⃣ Generate Reports
      - name: Generate Power Tuner PNG/HTML
        run: |
          mkdir -p reports
          VIS=$(jq -r '.stateMachine.visualization' tuning-output.json)
          curl -s "$VIS" -o reports/vis.json
          jq -r '.svg' reports/vis.json > reports/power-tuner.svg
          sudo apt-get install -y librsvg2-bin
          rsvg-convert -f png -o reports/power-tuner.png reports/power-tuner.svg
          echo "<html><body><img src=\"power-tuner.png\"></body></html>" > reports/power-tuner.html

      # 5️⃣ Manual Approval (if ASK_APPROVAL = true)
      - name: Await Approval Before Change
        if: env.ASK_APPROVAL == 'true'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "Approve Memory Update to ${{ env.BEST }} MB"
          issue-body: "Approve applying recommended Lambda memory?"

      # 6️⃣ Apply Memory Change
      - name: Apply Memory Update
        run: |
          aws lambda update-function-configuration \
            --function-name "$PROJECT-function" \
            --memory-size "$BEST"

      # 7️⃣ Run Postman Smoke Tests
      - name: Run Tests
        run: |
          npm i -g newman newman-reporter-html
          newman run postman/collection.json \
            -e postman/env.json \
            --env-var apiBase="$INVOKE_URL" \
            --reporters cli,html \
            --reporter-html-export reports/newman.html

      # 8️⃣ Upload Reports
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tuning-artifacts
          path: reports/
