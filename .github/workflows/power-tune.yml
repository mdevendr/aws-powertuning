name: Power Tune Lambda

on:
  pull_request:
    branches: [main] # run on PRs targeting main
  push:
    branches: [main] # only main can deploy
  workflow_dispatch: {} # manual run (still respects branch rules)

permissions:
  id-token: write # for OIDC to AWS
  contents: write

env:
  AWS_REGION: eu-west-2
  PROJECT: serverless-power-tuning
  TABLE_NAME: items
  DEPLOY_APPROVER: "mdevendr" # only this GitHub user can deploy

concurrency:
  group: power-tune-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # --- CI on PRs (no deployment) ---
  pr-checks:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Package Lambda
        working-directory: lambda
        run: |
          pip install -r requirements.txt -t .
          zip -r package.zip . >/dev/null
          ls -lh package.zip

      - name: Terraform init & validate
        working-directory: infra/terraform
        run: |
          terraform init -input=false
          terraform validate
          terraform fmt -check

      - name: Terraform plan (no apply)
        working-directory: infra/terraform
        run: |
          terraform plan -no-color -input=false

  # --- Deploy & Tune (only main) ---
  deploy-and-tune:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest

    # Block unless approved and only by you
    environment:
      name: production # in GitHub, protect this env & require reviewer @mdevendr
    steps:
      - name: Ensure only Mahesh can deploy
        if: ${{ github.actor != env.DEPLOY_APPROVER }}
        run: |
          echo "âŒ Deployment blocked: only ${DEPLOY_APPROVER} can deploy to main."
          exit 1

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Package Lambda
        working-directory: lambda
        run: |
          pip install -r requirements.txt -t .
          zip -r package.zip . >/dev/null
          ls -lh package.zip
      - name: Debug OIDC Token
        run: |
          echo "ðŸ”Ž Fetching OIDC Token..."
          TOKEN=$(curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r '.value')
          echo "Decoded OIDC Token Claims:"
          echo "$TOKEN" | base64 --decode | jq .

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init/Apply
        working-directory: infra/terraform
        run: |
          terraform init -input=false
          terraform apply -auto-approve -input=false
          echo "invoke_url=$(terraform output -raw invoke_url)" >> $GITHUB_ENV
          if terraform output -json power_tuner_arn >/dev/null 2>&1; then
            TF_TUNER=$(terraform output -raw power_tuner_arn || echo "")
            echo "tf_power_tuner_arn=$TF_TUNER" >> $GITHUB_ENV
          fi

      - name: Discover Lambda ARN
        id: lambda
        run: |
          ARN=$(aws lambda get-function --function-name "${PROJECT}-function" --query 'Configuration.FunctionArn' --output text)
          echo "arn=$ARN" >> $GITHUB_OUTPUT

      - name: Run AWS Lambda Power Tuning
        id: tune
        run: |
          # Prefer secret; fallback to Terraform-provisioned ARN
          POWER_TUNER_ARN="${{ secrets.POWER_TUNER_ARN }}"
          if [ -z "${POWER_TUNER_ARN}" ]; then POWER_TUNER_ARN="${{ env.tf_power_tuner_arn }}"; fi
          if [ -z "${POWER_TUNER_ARN}" ]; then echo "Power Tuner ARN not available"; exit 1; fi
          STRATEGY="balanced"
          INPUT=$(jq -n --arg farn "${{ steps.lambda.outputs.arn }}" --arg strat "$STRATEGY" '{
            lambdaARN:$farn, powerValues:[128,256,512,1024], num:20, payload:{},
            parallelInvocation:true, strategy:$strat
          }')
          EXE=$(aws stepfunctions start-execution --state-machine-arn "$POWER_TUNER_ARN" --input "$INPUT" --query executionArn --output text)
          echo "Started: $EXE"
          while true; do
            STATUS=$(aws stepfunctions describe-execution --execution-arn "$EXE" --query status --output text)
            echo "Status: $STATUS"
            if [ "$STATUS" = "SUCCEEDED" ]; then break; fi
            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "TIMED_OUT" ] || [ "$STATUS" = "ABORTED" ]; then echo "Execution $STATUS"; exit 1; fi
            sleep 10
          done
          OUT=$(aws stepfunctions describe-execution --execution-arn "$EXE" --query output --output text)
          echo "$OUT" > tuning-output.json
          BEST=$(jq -r '.power' tuning-output.json)
          echo "best=$BEST" >> $GITHUB_OUTPUT
          echo "Recommended memory: ${BEST} MB"

      - name: Update Lambda memory
        run: |
          aws lambda update-function-configuration --function-name "${PROJECT}-function" --memory-size "${{ steps.tune.outputs.best }}"

      - name: Run Newman smoke tests
        run: |
          npm i -g newman newman-reporter-html
          mkdir -p reports
          newman run postman/collection.json -e postman/env.json \
            --env-var apiBase="${{ env.invoke_url }}" \
            --reporters cli,html --reporter-html-export reports/newman.html

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tuning-and-tests
          path: |
            tuning-output.json
            reports/newman.html
