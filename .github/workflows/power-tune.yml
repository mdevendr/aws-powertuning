name: Power Tune Lambda

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: eu-west-2
  PROJECT: serverless-power-tuning
  TABLE_NAME: LambdaPowerTuningTable

jobs:
  deploy-and-tune:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for newman)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python (for html2text)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ⬅️ Reverted to your working version (no audience/output-env-credentials)
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # If your Lambda.zip is built elsewhere, keep that; otherwise:
      - name: Package Lambda (sample)
        run: |
          if [ -f lambda/app.py ]; then
            (cd lambda && zip -r ../lambda.zip app.py >/dev/null)
          fi
          test -f lambda.zip && echo "Packaged lambda.zip"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        env:
          TF_VAR_memory_update_mode: manual
        run: |
          terraform apply -auto-approve
          echo "INVOKE_URL=$(terraform output -raw invoke_url)" >> $GITHUB_ENV
          echo "POWER_TUNER_ARN=$(terraform output -raw power_tuner_arn)" >> $GITHUB_ENV
          echo "MEMORY_UPDATE_MODE=$(terraform output -raw memory_update_mode)" >> $GITHUB_ENV

      - name: Show resolved outputs
        run: |
          echo "Invoke URL:  $INVOKE_URL"
          echo "PowerTuner:  $POWER_TUNER_ARN"
          echo "Mem Update:  $MEMORY_UPDATE_MODE"

      - name: Run Power Tuner
        id: tune
        run: |
          set -e
          if [ -z "$POWER_TUNER_ARN" ]; then
            echo "❌ POWER_TUNER_ARN is empty. Enable SAR deploy or set var.power_tuner_arn."
            exit 1
          fi

          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          INPUT=$(jq -n \
            --arg lambda "arn:aws:lambda:${AWS_REGION}:${AWS_ACCOUNT_ID}:function:${PROJECT}-function" \
            --arg strat "balanced" \
            '{
              lambdaARN: $lambda,
              powerValues: [128,256,512,1024],
              num: 20,
              payload: {},
              parallelInvocation: true,
              strategy: $strat
            }')

          EXE=$(aws stepfunctions start-execution \
            --state-machine-arn "$POWER_TUNER_ARN" \
            --input "$INPUT" \
            --query executionArn \
            --output text)

          echo "Started: $EXE"

          while true; do
            STATUS=$(aws stepfunctions describe-execution \
              --execution-arn "$EXE" \
              --query status \
              --output text)
            echo "Status: $STATUS"
            if [ "$STATUS" = "SUCCEEDED" ]; then break; fi
            if [[ "$STATUS" == "FAILED" || "$STATUS" == "TIMED_OUT" || "$STATUS" == "ABORTED" ]]; then
              echo "❌ Execution $STATUS"; exit 1
            fi
            sleep 8
          done

          aws stepfunctions describe-execution --execution-arn "$EXE" --query output --output text > tuning-output.json
          BEST=$(jq -r '.power' tuning-output.json)
          echo "best=$BEST" >> $GITHUB_OUTPUT
          echo "✅ Recommended memory: ${BEST} MB"

      # Manual approval gate when memory_update_mode = manual
      - name: Await Approval
        if: ${{ env.MEMORY_UPDATE_MODE == 'manual' }}
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "Approve Lambda memory update to ${{ steps.tune.outputs.best }} MB"
          issue-body: "Approve to apply recommended memory size to ${{ env.PROJECT }}-function."

      - name: Apply recommended memory size (auto mode)
        if: ${{ env.MEMORY_UPDATE_MODE == 'auto' }}
        run: |
          if [ -z "${{ steps.tune.outputs.best }}" ]; then echo "❌ No best memory value"; exit 1; fi
          aws lambda update-function-configuration \
            --function-name "${{ env.PROJECT }}-function" \
            --memory-size "${{ steps.tune.outputs.best }}"
          echo "✅ Memory updated to ${{ steps.tune.outputs.best }} MB"

      - name: Run Newman smoke tests
        run: |
          npm i -g newman newman-reporter-html
          mkdir -p reports
          newman run postman/collection.json \
            -e postman/env.json \
            --env-var apiBase="$INVOKE_URL" \
            --env-var awsAccessKeyId="$AWS_ACCESS_KEY_ID" \
            --env-var awsSecretAccessKey="$AWS_SECRET_ACCESS_KEY" \
            --env-var awsSessionToken="$AWS_SESSION_TOKEN" \
            --reporters cli,html \
            --reporter-html-export reports/newman.html

      - name: Convert HTML report to Markdown
        run: |
          pip install html2text
          html2text reports/newman.html > reports/newman.md
          head -n 20 reports/newman.md || true

      - name: Commit reports back to repo
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          mkdir -p reports/history
          ts=$(date +%Y%m%d-%H%M%S)
          cp reports/newman.html reports/history/newman-$ts.html
          cp reports/newman.md   reports/history/newman-$ts.md
          test -f tuning-output.json && cp tuning-output.json reports/history/tuning-$ts.json || true
          git add reports/history/*
          git commit -m "Add CI reports at $ts" || echo "No report changes to commit"
          git push

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tuning-and-tests
          path: |
            reports/newman.html
            reports/newman.md
            reports/history/
            tuning-output.json
